---
/**
 * RecipeOutput Component
 * Displays calculated recipe in a clean, printable format
 * Supports both single-stage and two-stage (pre-ferment) recipes
 */
---

<div class="recipe-output" aria-live="polite" aria-atomic="false">
  <!-- Screen reader announcement region -->
  <div id="recipe-announcement" class="sr-only" aria-live="polite" aria-atomic="true"></div>
  {/* Recipe header */}
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-heading text-2xl font-bold text-text">Your Recipe</h2>
    <div class="flex items-center gap-2 no-print">
      {/* Unit toggle */}
      <button
        type="button"
        id="unitToggle"
        class="px-3 py-1.5 text-sm font-medium bg-cream border border-border rounded-lg hover:border-primary transition-colors"
        aria-label="Toggle units"
      >
        <span id="unitGrams" class="text-primary font-semibold">g</span>
        <span class="text-text-muted/50"> / </span>
        <span id="unitOunces" class="text-text-muted/50">oz</span>
      </button>
    </div>
  </div>

  {/* Single stage recipe card - Paper style */}
  <div id="singleStageRecipe" class="recipe-card relative bg-[#FFFDF8] rounded-2xl border border-crust shadow-[0_8px_40px_-12px_rgba(45,42,36,0.15)] overflow-hidden">
    {/* Decorative torn edge */}
    <div class="absolute top-0 left-0 right-0 h-3 bg-ember" style="clip-path: polygon(0% 0%, 2% 100%, 4% 0%, 6% 100%, 8% 0%, 10% 100%, 12% 0%, 14% 100%, 16% 0%, 18% 100%, 20% 0%, 22% 100%, 24% 0%, 26% 100%, 28% 0%, 30% 100%, 32% 0%, 34% 100%, 36% 0%, 38% 100%, 40% 0%, 42% 100%, 44% 0%, 46% 100%, 48% 0%, 50% 100%, 52% 0%, 54% 100%, 56% 0%, 58% 100%, 60% 0%, 62% 100%, 64% 0%, 66% 100%, 68% 0%, 70% 100%, 72% 0%, 74% 100%, 76% 0%, 78% 100%, 80% 0%, 82% 100%, 84% 0%, 86% 100%, 88% 0%, 90% 100%, 92% 0%, 94% 100%, 96% 0%, 98% 100%, 100% 0%, 100% 100%, 0% 100%);"></div>

    {/* Recipe title bar */}
    <div class="bg-gradient-to-r from-ember to-ember-deep text-white px-6 py-5 mt-2">
      <h3 id="recipeStyleName" class="font-heading text-2xl font-bold tracking-tight">Neapolitan Pizza Dough</h3>
      <p id="recipeSummary" class="text-white/90 text-sm mt-1.5 font-medium">
        Makes 4 dough balls at 250g each (1000g total)
      </p>
    </div>

    {/* Ingredients */}
    <div class="p-6">
      <h4 class="font-heading text-lg font-semibold text-text mb-4 flex items-center gap-2">
        <span>Ingredients</span>
        <span class="text-xs font-normal text-text-muted">(Baker's %)</span>
      </h4>

      <ul id="ingredientsList" class="space-y-3">
        <li class="ingredient-row flex items-center justify-between py-2 border-b border-border/50">
          <span class="text-text">Flour</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="flour">599g</span>
            <span class="text-sm text-text-muted w-16 text-right">(100%)</span>
          </div>
        </li>
        <li class="ingredient-row flex items-center justify-between py-2 border-b border-border/50">
          <span class="text-text">Water</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="water">389g</span>
            <span class="text-sm text-text-muted w-16 text-right" id="waterPercent">(65%)</span>
          </div>
        </li>
        <li class="ingredient-row flex items-center justify-between py-2 border-b border-border/50">
          <span class="text-text">Salt</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="salt">12g</span>
            <span class="text-sm text-text-muted w-16 text-right" id="saltPercent">(2%)</span>
          </div>
        </li>
        <li class="ingredient-row flex items-center justify-between py-2 border-b border-border/50">
          <span class="text-text">Instant Yeast</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="yeast">1.8g</span>
            <span class="text-sm text-text-muted w-16 text-right" id="yeastPercent">(0.3%)</span>
          </div>
        </li>
        <li id="oilRow" class="ingredient-row flex items-center justify-between py-2 border-b border-border/50 hidden">
          <span class="text-text">Olive Oil</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="oil">0g</span>
            <span class="text-sm text-text-muted w-16 text-right" id="oilPercent">(0%)</span>
          </div>
        </li>
        <li id="sugarRow" class="ingredient-row flex items-center justify-between py-2 hidden">
          <span class="text-text">Sugar</span>
          <div class="flex items-center gap-4">
            <span class="font-mono font-medium text-text" data-ingredient="sugar">0g</span>
            <span class="text-sm text-text-muted w-16 text-right" id="sugarPercent">(0%)</span>
          </div>
        </li>
      </ul>

      {/* Water temperature and flour recommendations */}
      <div class="mt-4 space-y-2">
        <div id="waterTempRecommendation" class="p-3 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-sm text-text">
            <span class="font-medium">Water temperature:</span>
            <span id="waterTempText">55-60°F / 13-16°C (cold)</span>
          </p>
        </div>
        <div id="flourRecommendation" class="p-3 bg-olive/10 rounded-lg border border-olive/20">
          <p class="text-sm text-text">
            <span class="font-medium">Recommended flour:</span>
            <span id="flourRecommendationText">00 Flour (Caputo Pizzeria)</span>
            <span id="flourProteinText" class="text-text-muted ml-1">(11-12.5% protein)</span>
          </p>
        </div>
      </div>
    </div>

    {/* Instructions */}
    <div class="px-6 pb-6">
      <h4 class="font-heading text-lg font-semibold text-text mb-4">Instructions</h4>
      <ol id="instructionsList" class="space-y-3 text-sm text-text-muted">
        <li class="flex gap-3">
          <span class="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">1</span>
          <span>Combine flour and water in a large bowl. Mix until no dry flour remains. Cover and rest 20-30 minutes (autolyse).</span>
        </li>
        <li class="flex gap-3">
          <span class="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">2</span>
          <span>Add salt and yeast. Knead for 8-10 minutes until smooth and elastic. The dough should pass the windowpane test.</span>
        </li>
        <li class="flex gap-3">
          <span class="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">3</span>
          <span id="fermentInstruction">Bulk ferment 1-2 hours at room temp, then cold ferment 24-72 hours. Remove from fridge 2 hours before balling. Proof balls 2-4 hours before stretching.</span>
        </li>
        <li class="flex gap-3">
          <span class="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">4</span>
          <span id="bakeInstruction">Stretch and bake at 450-500°C (850-900°F) for 60-90 seconds.</span>
        </li>
      </ol>
    </div>

    {/* Action buttons */}
    <div class="px-6 pb-6 flex flex-wrap gap-3 no-print">
      <button
        type="button"
        id="printRecipe"
        class="flex items-center gap-2 px-4 py-2 bg-charcoal text-white rounded-lg hover:bg-charcoal-light transition-colors"
        aria-label="Print recipe"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        Print
      </button>
      <button
        type="button"
        id="shareRecipe"
        class="flex items-center gap-2 px-4 py-2 bg-olive text-white rounded-lg hover:bg-olive-dark transition-colors"
        aria-label="Share recipe"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
        </svg>
        Share
      </button>
      <button
        type="button"
        id="copyRecipe"
        class="flex items-center gap-2 px-4 py-2 border border-border text-text rounded-lg hover:border-primary hover:text-primary transition-colors"
        aria-label="Copy recipe to clipboard"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        Copy
      </button>
    </div>
  </div>

  {/* Two-stage recipe (shown when pre-ferment is enabled) */}
  <div id="twoStageRecipe" class="hidden space-y-6">
    {/* Stage 1: Pre-ferment */}
    <div class="recipe-card bg-surface rounded-xl border border-border overflow-hidden">
      <div class="bg-olive text-white px-6 py-4">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold">1</span>
          <div>
            <h3 id="preFermentTitle" class="font-heading text-xl font-bold">Poolish (Night Before)</h3>
            <p class="text-white/80 text-sm">Start 12-16 hours before making pizza</p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <ul id="preFermentIngredients" class="space-y-3">
          <li class="flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Flour</span>
            <span class="font-mono font-medium text-text" data-pf-ingredient="flour">150g</span>
          </li>
          <li class="flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Water</span>
            <span class="font-mono font-medium text-text" data-pf-ingredient="water">150g</span>
          </li>
          <li class="flex items-center justify-between py-2">
            <span class="text-text">Instant Yeast</span>
            <span class="font-mono font-medium text-text" data-pf-ingredient="yeast">0.2g</span>
          </li>
        </ul>

        <div class="mt-4 p-3 bg-olive/10 rounded-lg">
          <p class="text-sm text-text">
            Mix ingredients until combined. Cover loosely and ferment at room temperature (68-72°F) for 12-16 hours.
            It's ready when bubbly and slightly domed.
          </p>
        </div>
      </div>
    </div>

    {/* Stage 2: Final dough */}
    <div class="recipe-card bg-surface rounded-xl border border-border overflow-hidden">
      <div class="bg-primary text-white px-6 py-4">
        <div class="flex items-center gap-2">
          <span class="text-2xl font-bold">2</span>
          <div>
            <h3 class="font-heading text-xl font-bold">Final Dough (Next Day)</h3>
            <p id="finalDoughSummary" class="text-white/80 text-sm">
              Makes 4 dough balls at 250g each (1000g total)
            </p>
          </div>
        </div>
      </div>

      <div class="p-6">
        <ul id="finalDoughIngredients" class="space-y-3">
          <li class="flex items-center justify-between py-2 border-b border-border/50 bg-olive/5 -mx-2 px-2 rounded">
            <span class="text-text font-medium">Poolish (from above)</span>
            <span class="font-mono font-medium text-olive">All of it</span>
          </li>
          <li class="flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Flour (remaining)</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="flour">449g</span>
          </li>
          <li class="flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Water (remaining)</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="water">239g</span>
          </li>
          <li class="flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Salt</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="salt">12g</span>
          </li>
          <li id="finalYeastRow" class="hidden flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Instant Yeast (remaining)</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="yeast">0g</span>
          </li>
          <li id="finalOilRow" class="hidden flex items-center justify-between py-2 border-b border-border/50">
            <span class="text-text">Olive Oil</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="oil">0g</span>
          </li>
          <li id="finalSugarRow" class="hidden flex items-center justify-between py-2">
            <span class="text-text">Sugar</span>
            <span class="font-mono font-medium text-text" data-final-ingredient="sugar">0g</span>
          </li>
        </ul>

        <div class="mt-4 p-3 bg-primary/5 rounded-lg">
          <p class="text-sm text-text">
            Add pre-ferment to remaining ingredients. Knead 8-10 min until smooth. Bulk ferment 2-3 hours at room temp. Divide, ball, and proof 2-4 hours before stretching.
          </p>
        </div>
      </div>

      {/* Action buttons */}
      <div class="px-6 pb-6 flex flex-wrap gap-3 no-print">
        <button
          type="button"
          id="printRecipe2"
          class="flex items-center gap-2 px-4 py-2 bg-charcoal text-white rounded-lg hover:bg-charcoal-light transition-colors"
          aria-label="Print recipe"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
          </svg>
          Print
        </button>
        <button
          type="button"
          id="shareRecipe2"
          class="flex items-center gap-2 px-4 py-2 bg-olive text-white rounded-lg hover:bg-olive-dark transition-colors"
          aria-label="Share recipe"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
          </svg>
          Share
        </button>
        <button
          type="button"
          id="copyRecipe2"
          class="flex items-center gap-2 px-4 py-2 border border-border text-text rounded-lg hover:border-primary hover:text-primary transition-colors"
          aria-label="Copy recipe to clipboard"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          Copy
        </button>
      </div>
    </div>
  </div>

  {/* Share modal */}
  <div
    id="shareModal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 no-print"
    role="dialog"
    aria-modal="true"
    aria-labelledby="share-modal-title"
  >
    <div class="bg-surface rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
      <h3 id="share-modal-title" class="font-heading text-xl font-bold text-text mb-4">Share This Recipe</h3>
      <div class="flex gap-2">
        <label for="shareUrl" class="sr-only">Recipe share URL</label>
        <input
          type="text"
          id="shareUrl"
          readonly
          class="flex-1 px-3 py-2 bg-cream border border-border rounded-lg text-text text-sm"
        />
        <button
          type="button"
          id="copyShareUrl"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors"
        >
          Copy
        </button>
      </div>
      <p id="shareConfirmation" class="hidden mt-2 text-sm text-olive font-medium" role="status" aria-live="polite">
        Link copied to clipboard!
      </p>
      <button
        type="button"
        id="closeShareModal"
        class="mt-4 w-full px-4 py-2 border border-border text-text rounded-lg hover:bg-cream transition-colors"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  // Print functionality
  document.querySelectorAll('#printRecipe, #printRecipe2').forEach(btn => {
    btn?.addEventListener('click', () => window.print());
  });

  // Share modal
  const shareModal = document.getElementById('shareModal');
  const shareUrl = document.getElementById('shareUrl');
  const copyShareUrl = document.getElementById('copyShareUrl');
  const shareConfirmation = document.getElementById('shareConfirmation');
  const closeShareModal = document.getElementById('closeShareModal');
  let lastFocusedElement = null;

  function openShareModal() {
    if (shareModal && shareUrl) {
      lastFocusedElement = document.activeElement;
      shareModal.classList.remove('hidden');
      shareModal.classList.add('flex');
      // Focus the URL input
      shareUrl.focus();
      shareUrl.select();
    }
  }

  function closeModal() {
    shareModal?.classList.add('hidden');
    shareModal?.classList.remove('flex');
    // Return focus to the element that opened the modal
    lastFocusedElement?.focus();
  }

  document.querySelectorAll('#shareRecipe, #shareRecipe2').forEach(btn => {
    btn?.addEventListener('click', openShareModal);
  });

  copyShareUrl?.addEventListener('click', async () => {
    if (shareUrl) {
      await navigator.clipboard.writeText(shareUrl.value);
      shareConfirmation?.classList.remove('hidden');
      setTimeout(() => shareConfirmation?.classList.add('hidden'), 2000);
    }
  });

  closeShareModal?.addEventListener('click', closeModal);

  // Close on backdrop click
  shareModal?.addEventListener('click', (e) => {
    if (e.target === shareModal) {
      closeModal();
    }
  });

  // Keyboard handling for modal
  shareModal?.addEventListener('keydown', (e) => {
    // Close on Escape
    if (e.key === 'Escape') {
      closeModal();
      return;
    }

    // Focus trap
    if (e.key === 'Tab') {
      const focusableElements = shareModal.querySelectorAll('input, button');
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  });
</script>
